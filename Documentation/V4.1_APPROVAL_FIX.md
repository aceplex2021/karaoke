# v4.1 Approval System Fix

## Problem
Host approval system was not working due to schema mismatch:
1. Code was trying to insert/select `user_name` from `kara_room_participants`
2. Database didn't have `user_name` column in that table
3. Users never received "waiting for approval" message
4. Host never received approval requests

## Root Cause
The v4.0 migration (`database/v4.0_youtube_approval.sql`) added approval fields (`role`, `status`, `approved_at`, `expires_at`) but did NOT add `user_name` column, even though the application code expected it.

## Solution

### 1. Database Migration
**File:** `database/v4.1_fix_approval.sql`

Adds missing `user_name` column to `kara_room_participants`:
```sql
ALTER TABLE kara_room_participants
ADD COLUMN IF NOT EXISTS user_name VARCHAR(255);

-- Backfill existing rows
UPDATE kara_room_participants p
SET user_name = u.display_name
FROM kara_users u
WHERE p.user_id = u.id
AND p.user_name IS NULL;
```

**HOW TO RUN:**
1. Go to Supabase SQL Editor
2. Copy contents of `database/v4.1_fix_approval.sql`
3. Run the script
4. Verify with the included SELECT query

### 2. Backend API Changes

#### New API Endpoint: User Status Check
**File:** `src/app/api/rooms/[roomId]/user-status/route.ts` (NEW)
- Returns user's approval status: `approved`, `pending`, `denied`, or `not_joined`
- Auto-expires pending requests after 15 minutes
- Used by frontend to check approval state

#### Fixed: Room Join
**File:** `src/app/api/rooms/join/route.ts`
- Now properly inserts `user_name` into `kara_room_participants`
- Uses user's `display_name` or 'Guest' as fallback

#### Fixed: Pending Users List
**File:** `src/app/api/rooms/[roomId]/pending-users/route.ts`
- Already selecting `user_name` correctly
- Needed the database column to exist

### 3. Frontend Changes

#### Added to `src/lib/api.ts`:
```typescript
async getUserStatus(roomId: string, userId: string): Promise<{ status: string; participant: any }>
```

#### Updated `src/app/room/[code]/page.tsx`:
1. **Added state:** `userApprovalStatus`
2. **Added function:** `checkApprovalStatus()` - checks user's approval status
3. **Added function:** `startApprovalPolling()` - polls status every 3s for pending users
4. **Updated:** `joinRoom()` - now checks approval status after joining
5. **Added UI:** Orange banner showing "Waiting for Host Approval" when `status='pending'`
6. **Added UI:** Red banner showing "Access Denied" when `status='denied'`

### 4. User Flow

#### For Users (v4.0 with Approval Mode):
1. User enters room code and name
2. User clicks "Join Room"
3. **IF room has approval mode enabled:**
   - User sees orange banner: "⏳ Waiting for Host Approval"
   - App polls approval status every 3 seconds
   - User CANNOT add songs until approved
4. **When host approves:**
   - Banner disappears
   - User can now add songs
5. **If approval expires (15 min) or host denies:**
   - Red banner: "❌ Access Denied"
   - User cannot add songs

#### For Host:
1. Host creates room with "Host Approval" mode
2. When user joins, host sees them in "Approval" tab
3. Host clicks "Approve" or "Deny"
4. User's status updates instantly (within 3s via polling)

## Testing Checklist

### Database
- [ ] Run `database/v4.1_fix_approval.sql` in Supabase
- [ ] Verify `user_name` column exists: `\d kara_room_participants`
- [ ] Check existing rows have names backfilled

### Backend API
- [ ] Join room with approval mode → status should be `pending`
- [ ] Check `/api/rooms/[roomId]/pending-users` → should show user with name
- [ ] Check `/api/rooms/[roomId]/user-status?userId=xxx` → should return `pending`
- [ ] Approve user → status should change to `approved`
- [ ] Wait 15+ minutes → pending status should auto-expire to `denied`

### Frontend
- [ ] User joins approval room → sees orange "Waiting for Approval" banner
- [ ] Host approves → banner disappears (within 3 seconds)
- [ ] Host denies → red "Access Denied" banner appears
- [ ] User tries to add song while pending → should be blocked (future enhancement)
- [ ] Approval request expires → red banner appears

## What's Next

### Optional Enhancement:
Disable "Add to Queue" buttons when `userApprovalStatus !== 'approved'`:
- Disable YouTube search
- Disable paste link
- Disable database search (v3.5 mode)
- Show tooltip: "Waiting for host approval"

This can be added later if needed.

## Files Changed

### Database
- ✅ `database/v4.1_fix_approval.sql` (NEW)

### Backend
- ✅ `src/app/api/rooms/[roomId]/user-status/route.ts` (NEW)
- ✅ `src/app/api/rooms/join/route.ts` (MODIFIED)

### Frontend  
- ✅ `src/lib/api.ts` (MODIFIED - added `getUserStatus`)
- ✅ `src/app/room/[code]/page.tsx` (MODIFIED - added approval status UI and polling)

## Git
```bash
git tag v4.1
# Tagged current version as v4.1
```
