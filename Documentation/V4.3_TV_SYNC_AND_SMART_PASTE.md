# V4.3: Multi-TV Sync & iOS Smart Paste

## Overview

V4.3 introduces two major enhancements for commercial mode (YouTube):
1. **Multi-TV Synchronization** - Primary/secondary TV support with audio control
2. **iOS Smart Paste** - Intelligent clipboard detection for YouTube URLs

---

## Feature 1: Multi-TV Synchronization

### Problem Statement
When multiple TVs are connected to the same room, they need to:
- Play the same video at the same time
- Only one TV should output audio (to prevent echo)
- Stay in sync (within 500ms tolerance)
- Handle disconnections gracefully

### Solution Design

#### Primary/Secondary Model
- **First TV to connect** â†’ PRIMARY (video + ðŸ”Š audio)
- **All subsequent TVs** â†’ SECONDARY (video only, ðŸ”‡ muted)

#### Visual Indicators
- Primary TV shows: "ðŸ”Š PRIMARY DISPLAY" badge (green)
- Secondary TVs show: "ðŸ“º SECONDARY DISPLAY" badge (gray)

#### Timestamp-Based Sync
- When a song starts, `current_song_started_at` timestamp is stored in database
- All TVs calculate elapsed time: `elapsed = now() - started_at`
- Each TV seeks to the correct position on load/refresh
- Every 2.5s polling cycle, TVs check for drift >500ms and auto-correct

### Implementation

#### Database Changes (`v4.3_tv_sync.sql`)
```sql
ALTER TABLE kara_rooms
ADD COLUMN primary_tv_id UUID,
ADD COLUMN current_song_started_at TIMESTAMPTZ;
```

#### API Endpoints

**POST `/api/rooms/[roomId]/register-tv`**
- Registers a TV as primary (if none exists) or secondary
- Returns `{ is_primary: boolean }`

#### TV Page Changes (`src/app/tv/page.tsx`)
- Generates unique TV ID (stored in localStorage)
- Registers with room on load
- Shows primary/secondary badge
- Mutes YouTube player for secondary TVs
- Adds "Leave page?" warning

#### YouTube Player Updates (`src/components/YouTubePlayer.tsx`)
- Added `muted` prop
- Mutes player in `handleReady` if `muted=true`

#### Advance API Updates (`src/app/api/rooms/[roomId]/advance/route.ts`)
- Sets `current_song_started_at` timestamp when advancing to next song

### User Experience

**Setup:**
1. Host opens TV 1 â†’ automatically becomes PRIMARY (audio ON)
2. Host opens TV 2 â†’ automatically becomes SECONDARY (video only)
3. Both TVs show same video at same time

**During Playback:**
- All TVs stay in sync (within 500ms)
- Only primary TV outputs audio
- If TV 1 closes, host just reloads any TV to make it primary

**Leave Prevention:**
- Browser warns: "Leave page? This will close the TV display"
- Prevents accidental navigation

---

## Feature 2: iOS Smart Paste

### Problem Statement
On iOS, users must:
1. Copy YouTube URL (from YouTube app or Safari)
2. Switch to Kara app
3. Manually paste URL into input field
4. Tap "Add to Queue"

This is 4 steps when it could be 2.

### Solution Design

#### Auto-Detection Flow
1. User copies YouTube URL (anywhere)
2. User opens Kara app
3. User **taps** on "Add song" input field
4. App **auto-detects** YouTube URL from clipboard
5. **Toast appears** at top: "ðŸŽµ YouTube link detected! [Song Title]"
6. User taps "Add to Queue" â†’ done!

**Result:** 3 taps instead of 4+ actions

### Implementation

#### Clipboard Detection (`src/app/room/[code]/page.tsx`)
```typescript
const handleClipboardDetection = async () => {
  // Read clipboard
  const clipboardText = await navigator.clipboard.readText();
  
  // Check if YouTube URL
  if (isYouTubeURL(clipboardText)) {
    // Fetch metadata using oEmbed API
    const oembedUrl = `https://www.youtube.com/oembed?url=${clipboardText}`;
    const response = await fetch(oembedUrl);
    const data = await response.json();
    
    // Show toast with title
    setClipboardYouTube({
      url: clipboardText,
      title: data.title,
    });
    
    // Auto-dismiss after 8 seconds
    setTimeout(() => setClipboardYouTube(null), 8000);
  }
};
```

#### Toast UI
- Position: Top center (fixed)
- Style: Blue gradient with white text
- Content: "ðŸŽµ YouTube link detected! [Song Title]"
- Actions: "Add to Queue" button, Close (âœ•) button
- Animation: Slide down (0.3s ease-out)
- Duration: Auto-dismiss after 8 seconds

#### Input Field Update
```tsx
<input 
  onFocus={handleClipboardDetection}
  placeholder="Paste YouTube URL here..."
/>
```

### User Experience

**Before v4.3:**
1. Copy YouTube URL â†’ Switch to Kara â†’ Tap input â†’ Long-press â†’ Paste â†’ Tap "Add to Queue"
2. **Total: 6 actions**

**After v4.3:**
1. Copy YouTube URL â†’ Switch to Kara â†’ Tap input â†’ Tap "Add to Queue" (in toast)
2. **Total: 4 actions, 33% faster!**

### Technical Notes

**Why oEmbed?**
- No API key required
- No rate limits (generous)
- Returns title, author, thumbnail
- URL: `https://www.youtube.com/oembed?url={URL}&format=json`

**Clipboard Permissions:**
- iOS requires user gesture (tap on input)
- Permission prompt appears once
- User can deny (feature gracefully fails)

**Toast Auto-Dismiss:**
- 8 seconds gives user time to react
- User can manually close with âœ• button
- Adding song auto-closes toast

---

## Testing Checklist

### Multi-TV Sync
- [ ] TV 1 shows "ðŸ”Š PRIMARY DISPLAY" badge
- [ ] TV 2 shows "ðŸ“º SECONDARY DISPLAY" badge
- [ ] Only TV 1 outputs audio
- [ ] Both TVs show same video frame
- [ ] TVs stay in sync within 1-2 seconds
- [ ] Closing TV 1 and reopening makes it primary again
- [ ] Browser warns before leaving TV page

### iOS Smart Paste
- [ ] Copy YouTube URL from YouTube app
- [ ] Open Kara app â†’ tap input field
- [ ] Toast appears with correct song title
- [ ] Tap "Add to Queue" â†’ song added successfully
- [ ] Toast auto-dismisses after 8 seconds
- [ ] Tap âœ• â†’ toast closes immediately
- [ ] Non-YouTube URLs don't trigger toast

---

## Database Migration

**Before deploying v4.3, run:**
```bash
psql -h [host] -U [user] -d [database] -f database/v4.3_tv_sync.sql
```

---

## Files Changed

### New Files
- `database/v4.3_tv_sync.sql`
- `src/app/api/rooms/[roomId]/register-tv/route.ts`
- `Documentation/V4.3_TV_SYNC_AND_SMART_PASTE.md`

### Modified Files
- `package.json` â†’ v4.3.0
- `src/app/tv/page.tsx` â†’ Primary/secondary detection, leave warning, badge
- `src/app/room/[code]/page.tsx` â†’ Smart paste detection, toast UI
- `src/components/YouTubePlayer.tsx` â†’ Muted prop support
- `src/app/api/rooms/[roomId]/advance/route.ts` â†’ Timestamp tracking
- `src/shared/types.ts` â†’ Room type with new fields
- `src/app/globals.css` â†’ slideDown animation

---

## Configuration

**No environment variables needed!** Both features work automatically in commercial mode (`NEXT_PUBLIC_COMMERCIAL_MODE=true`).

### Feature Availability
- **TV Sync:** YouTube mode only (commercial mode)
- **Smart Paste:** All modes, but most useful in YouTube mode

---

## Performance Impact

### Multi-TV Sync
- **Network:** +1 API call per TV on load (register-tv)
- **Bandwidth:** Negligible (<1KB)
- **CPU:** Minimal (timestamp comparison every 2.5s)

### iOS Smart Paste
- **Network:** +1 API call per paste detection (oEmbed)
- **Bandwidth:** ~500 bytes per oEmbed request
- **CPU:** Negligible
- **User Perception:** **Instant** (oEmbed typically responds in 200-300ms)

---

## Future Enhancements (v4.4+)

### Multi-TV Sync
- [ ] Manual primary TV selection (host picks which TV has audio)
- [ ] Real-time sync corrections (WebSocket-based, <100ms accuracy)
- [ ] TV heartbeat monitoring (auto-promote secondary if primary disconnects)

### Smart Paste
- [ ] Auto-paste without user tap (background clipboard monitoring - if iOS allows in future)
- [ ] Paste history (show recent YouTube URLs)
- [ ] Batch paste (multiple URLs at once)

---

## Version History

**v4.3.0 (2026-01-22)**
- âœ… Multi-TV synchronization with primary/secondary model
- âœ… iOS smart paste with oEmbed metadata
- âœ… Leave page warning for TVs
- âœ… Toast auto-dismiss after 8 seconds

