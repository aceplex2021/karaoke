# V4.4: Supabase Realtime Multi-TV Sync

## Overview
Replaced 2.5-second polling with Supabase Realtime subscriptions for near-instant (<200ms) multi-TV synchronization.

---

## Features

### 1. **Realtime Subscription**
- All TVs subscribe to `kara_rooms` table changes
- Instant notification when `current_entry_id` changes
- ~100-200ms latency (vs 0-2.5s with polling)
- Automatic reconnection on network issues

### 2. **Mid-Song Connection Handling**
- Detects if TV connects while song is playing
- Shows beautiful waiting screen instead of out-of-sync video
- Automatically starts video when next song begins
- Message: "Video will start playing when the next song begins"

### 3. **Fallback to Polling**
- Automatically falls back to 2.5s polling if Realtime fails
- Graceful degradation ensures TVs always work
- Logs Realtime connection status for debugging

### 4. **Simultaneous Start**
- All connected TVs receive song change notification simultaneously
- All start from 0:00 together (no catchup/seeking)
- Primary TV has audio, secondary TVs muted

---

## Setup Instructions

### **CRITICAL: Enable Realtime in Supabase**

1. Go to https://supabase.com/dashboard
2. Select your project
3. Click **Database** → **Replication** (left sidebar)
4. Find `kara_rooms` table
5. Toggle **Enable Realtime** → ON
6. Click **Save**

**Without this step, Realtime won't work and TVs will fall back to polling!**

---

## How It Works

### **Connection Flow:**

```
1. TV connects to room
   ↓
2. Checks if song is currently playing
   ↓
   If YES: Show "Waiting for next song" message
   If NO: Start video immediately
   ↓
3. Subscribe to Realtime updates for room
   ↓
4. When song changes:
   - Receive Realtime notification (~100ms)
   - Load new video
   - Start from 0:00
   - Clear "waiting" flag if set
```

### **Sync Quality:**

| Scenario | Old (Polling) | New (Realtime) |
|----------|--------------|----------------|
| All TVs connected before song | 0-2.5s delay | ~100-200ms delay |
| TV connects mid-song | Out of sync entire song | Shows waiting message |
| Network reconnect | Up to 2.5s to detect | Instant reconnect |

---

## Testing Checklist

### **Test 1: Pre-Connected TVs**
1. Connect TV 1 → Should show PRIMARY badge
2. Connect TV 2 → Should show SECONDARY badge
3. Queue a song and start playback
4. **Expected:** Both TVs start within ~200ms of each other ✅

### **Test 2: Mid-Song Connection**
1. Connect TV 1 and start playing a song
2. Wait until song is ~30 seconds in
3. Connect TV 2
4. **Expected:** TV 2 shows "waiting" message (no video) ✅
5. Let song finish
6. **Expected:** Both TVs start next song simultaneously ✅

### **Test 3: Realtime Fallback**
1. Disconnect internet briefly while TV is connected
2. **Expected:** TV continues polling for updates ✅
3. Reconnect internet
4. **Expected:** TV reconnects to Realtime automatically ✅

---

## Console Logs (for Debugging)

**Successful Realtime:**
```
[tv] Setting up Realtime subscription for room: <uuid>
[tv] Realtime subscription status: SUBSCRIBED
[tv] ✅ Realtime connected
[tv] Realtime: Room updated <payload>
```

**Fallback to Polling:**
```
[tv] Realtime subscription status: CHANNEL_ERROR
[tv] ❌ Realtime failed, falling back to polling
[tv] Starting polling (2.5s interval)
```

**Mid-Song Connection:**
```
[tv] ⚠️ Joined mid-song - will wait for next song
[tv] ✅ New song started - clearing mid-song flag
```

---

## Technical Details

### **Files Modified:**
- `src/app/tv/page.tsx` - Realtime subscription, mid-song detection
- `src/app/globals.css` - Pulse animation for waiting screen
- `src/lib/supabase.ts` - Already has Realtime support

### **Database:**
- No schema changes required
- Just enable Realtime on `kara_rooms` table

### **Dependencies:**
- `@supabase/supabase-js` (already installed, has Realtime built-in)

---

## Troubleshooting

**Issue: TVs still out of sync by 2-3 seconds**
- **Cause:** Realtime not enabled in Supabase
- **Fix:** Follow "Setup Instructions" above

**Issue: Console shows "CHANNEL_ERROR"**
- **Cause:** Network firewall blocking WebSocket connections
- **Fix:** TVs will automatically fall back to polling

**Issue: "Waiting" message doesn't clear**
- **Cause:** Realtime notification not received
- **Fix:** Check Supabase Realtime is enabled, check console for errors

---

## Performance

**Before (Polling):**
- Request every 2.5 seconds
- ~30 API calls/minute per TV
- 0-2.5s sync delay

**After (Realtime):**
- WebSocket connection (1 per TV)
- ~0 API calls (only on actual changes)
- ~100-200ms sync delay
- **Lower cost, better sync!**

---

## Future Improvements

1. **Drift Correction (Optional):** Add periodic time sync check (every 10s) to re-align if drift > 500ms
2. **Manual Sync Button:** Allow host to force all TVs to re-sync
3. **Network Quality Indicator:** Show connection status on TV display

---

**Version:** v4.4  
**Date:** 2026-01-21  
**Status:** ✅ Implemented & Tested
