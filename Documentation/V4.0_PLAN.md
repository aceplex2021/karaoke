# ğŸš€ Karaoke v4.0 Implementation Plan
**Commercial-Safe YouTube Queue Manager (PWA)**

---

## ğŸ“‹ Executive Summary

**v4.0 Goal**: Transform the app into a commercial-safe, multi-user karaoke queue manager for YouTube videos, delivered as a PWA.

**Key Features**:
- âœ… PWA with YouTube share target integration
- âœ… Host approval system (15-min auto-expiry)
- âœ… YouTube iframe playback (with ads for legal compliance)
- âœ… Global feature toggle via `.env` (DB mode vs YouTube mode)
- âœ… Three device roles: Host, TV, User
- âœ… **ZERO caching** - polling every 2.5s (same as v3.5)
- âœ… 24-hour room expiry
- âœ… Auto-update PWA (no prompts)

**Deployment Strategy (Copyright Protection)**:
- ğŸ”’ **Two separate Vercel deployments required**
- ğŸŒ **Public deployment**: `COMMERCIAL_MODE=true` (YouTube only)
- ğŸ” **Private deployment**: `COMMERCIAL_MODE=false` (DB mode, password-protected)
- âš ï¸ **Never expose database mode publicly** (legal risk)

**Timeline**: 5-6 weeks

**Commercial Advantage**: No copyright issues - YouTube hosts and serves all content with ads

---

## ğŸ¯ User Flow Overview

### Landing Page (`/`)
```
User opens app â†’ Sees 3 options:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   What do you want to do?       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ¤ Create Room (Host)          â”‚  â†’ /create
â”‚  ğŸ“º I'm a TV/Media Player       â”‚  â†’ /tv-setup
â”‚  ğŸ‘¥ Join Room (User)            â”‚  â†’ /join
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Complete Flow Diagram
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        APP ENTRY                             â”‚
â”‚                    https://kara.app/                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                â”‚                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ğŸ¤ CREATE ROOM â”‚  â”‚ ğŸ“º TV SETUP â”‚  â”‚ ğŸ‘¥ JOIN     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                â”‚                 â”‚
                â†“                â†“                 â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Host Setup    â”‚  â”‚ Enter Code â”‚  â”‚ Enter Code  â”‚
        â”‚ Enter Name    â”‚  â”‚ EJ7TGW     â”‚  â”‚ EJ7TGW      â”‚
        â”‚ Choose Mode:  â”‚  â”‚            â”‚  â”‚ Enter Name  â”‚
        â”‚ â€¢ Auto Join   â”‚  â”‚            â”‚  â”‚             â”‚
        â”‚ â€¢ Approval    â”‚  â”‚            â”‚  â”‚             â”‚
        â”‚ Shows QR      â”‚  â”‚            â”‚  â”‚             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                â”‚                 â”‚
                â†“                â†“                 â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Host          â”‚  â”‚ TV Mode    â”‚  â”‚ Check       â”‚
        â”‚ Dashboard     â”‚  â”‚ (YouTube   â”‚  â”‚ Approval    â”‚
        â”‚ â€¢ Approvals   â”‚  â”‚  iframe)   â”‚  â”‚ Status      â”‚
        â”‚ â€¢ Queue       â”‚  â”‚            â”‚  â”‚             â”‚
        â”‚ â€¢ Stats       â”‚  â”‚ QR visible â”‚  â”‚             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â†“
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚ If Auto Join:   â”‚
                                          â”‚ â†’ Search Tab    â”‚
                                          â”‚                 â”‚
                                          â”‚ If Approval:    â”‚
                                          â”‚ â†’ Wait for Host â”‚
                                          â”‚                 â”‚
                                          â”‚ Search Tab:     â”‚
                                          â”‚ â†’ Redirect to YTâ”‚
                                          â”‚ â†’ Share to kara â”‚
                                          â”‚ â†’ Auto-add      â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“± Device Roles

| Device | Role | Can Do | Cannot Do |
|--------|------|--------|-----------|
| **Phone/Tablet** | Host | Create room, approve users, manage queue, add songs | - |
| **Phone/Tablet** | User | Join room, search & share YouTube, add to queue | Create room, approve others |
| **TV/Big Screen** | Media Player | Display queue, play YouTube videos, show QR code | Add songs, approve users |
| **Desktop/Laptop** | Any | Can act as Host, User, or TV | - |

---

## ğŸ—„ï¸ Database Schema Changes

### Minimal Changes to Existing Schema

We'll reuse existing tables and add only necessary fields:

```sql
-- ============================================
-- v4.0 Migration: YouTube & Approval Support
-- File: database/migrations/v4.0_youtube_approval.sql
-- ============================================

-- 1. Update kara_rooms (add approval mode and expiry)
ALTER TABLE kara_rooms 
ADD COLUMN IF NOT EXISTS approval_mode TEXT 
  CHECK (approval_mode IN ('auto', 'approval')) 
  DEFAULT 'auto',
ADD COLUMN IF NOT EXISTS expires_at TIMESTAMPTZ 
  DEFAULT (NOW() + INTERVAL '24 hours');

-- Update existing rooms to have expiry
UPDATE kara_rooms 
SET expires_at = created_at + INTERVAL '24 hours'
WHERE expires_at IS NULL;

-- 2. Update kara_queue (add YouTube support)
ALTER TABLE kara_queue
ADD COLUMN IF NOT EXISTS youtube_url TEXT,
ADD COLUMN IF NOT EXISTS source_type TEXT 
  CHECK (source_type IN ('database', 'youtube')) 
  DEFAULT 'database';

-- Add constraint: either version_id OR youtube_url, not both
ALTER TABLE kara_queue
DROP CONSTRAINT IF EXISTS check_queue_source;

ALTER TABLE kara_queue
ADD CONSTRAINT check_queue_source CHECK (
  (source_type = 'database' AND version_id IS NOT NULL AND youtube_url IS NULL) OR
  (source_type = 'youtube' AND youtube_url IS NOT NULL AND version_id IS NULL)
);

-- Make version_id nullable for YouTube entries
ALTER TABLE kara_queue 
ALTER COLUMN version_id DROP NOT NULL;

-- 3. Update kara_room_participants (add approval tracking)
ALTER TABLE kara_room_participants
ADD COLUMN IF NOT EXISTS role TEXT 
  CHECK (role IN ('host', 'tv', 'user')) 
  DEFAULT 'user',
ADD COLUMN IF NOT EXISTS status TEXT 
  CHECK (status IN ('approved', 'pending', 'denied')) 
  DEFAULT 'approved',
ADD COLUMN IF NOT EXISTS approved_at TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS expires_at TIMESTAMPTZ;

-- Index for fast approval lookups
CREATE INDEX IF NOT EXISTS idx_participants_status 
  ON kara_room_participants(status);
CREATE INDEX IF NOT EXISTS idx_participants_role 
  ON kara_room_participants(role);

-- 4. Function: Expire pending approvals
CREATE OR REPLACE FUNCTION expire_pending_approvals()
RETURNS void AS $$
BEGIN
  UPDATE kara_room_participants
  SET status = 'denied'
  WHERE status = 'pending'
  AND expires_at < NOW();
END;
$$ LANGUAGE plpgsql;

GRANT EXECUTE ON FUNCTION expire_pending_approvals() 
  TO authenticated, anon, service_role;

-- 5. Function: Expire old rooms
CREATE OR REPLACE FUNCTION expire_old_rooms()
RETURNS void AS $$
BEGIN
  UPDATE kara_rooms
  SET is_active = false
  WHERE expires_at < NOW()
  AND is_active = true;
END;
$$ LANGUAGE plpgsql;

GRANT EXECUTE ON FUNCTION expire_old_rooms() 
  TO authenticated, anon, service_role;

-- 6. Update advance_playback for YouTube
-- (Keep existing function, it will work with YouTube URLs)

-- ============================================
-- Verification
-- ============================================
SELECT 
  'kara_rooms' as table_name,
  COUNT(*) FILTER (WHERE column_name = 'approval_mode') as has_approval_mode,
  COUNT(*) FILTER (WHERE column_name = 'expires_at') as has_expires_at
FROM information_schema.columns
WHERE table_name = 'kara_rooms'
AND table_schema = 'public';

SELECT 
  'kara_queue' as table_name,
  COUNT(*) FILTER (WHERE column_name = 'youtube_url') as has_youtube_url,
  COUNT(*) FILTER (WHERE column_name = 'source_type') as has_source_type
FROM information_schema.columns
WHERE table_name = 'kara_queue'
AND table_schema = 'public';

SELECT 
  'kara_room_participants' as table_name,
  COUNT(*) FILTER (WHERE column_name = 'role') as has_role,
  COUNT(*) FILTER (WHERE column_name = 'status') as has_status,
  COUNT(*) FILTER (WHERE column_name = 'approved_at') as has_approved_at,
  COUNT(*) FILTER (WHERE column_name = 'expires_at') as has_expires_at
FROM information_schema.columns
WHERE table_name = 'kara_room_participants'
AND table_schema = 'public';
```

**Summary**: 
- âœ… No new tables needed
- âœ… Reuse existing `kara_room_participants` for approval tracking
- âœ… Minimal schema changes (4 fields to rooms, 2 to queue, 4 to participants)
- âœ… Backward compatible (existing data unaffected)

---

## ğŸ“ Directory Structure

```
c:\Users\aceon\AI\karaoke\
â”‚
â”œâ”€â”€ .env                              # Add NEXT_PUBLIC_COMMERCIAL_MODE=false
â”œâ”€â”€ .env-production                   # Add NEXT_PUBLIC_COMMERCIAL_MODE=true
â”‚
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ manifest.json                 # â† NEW: PWA manifest
â”‚   â”œâ”€â”€ sw.js                         # â† NEW: Service worker
â”‚   â””â”€â”€ icons/                        # â† NEW: App icons folder
â”‚       â”œâ”€â”€ icon-72x72.png
â”‚       â”œâ”€â”€ icon-96x96.png
â”‚       â”œâ”€â”€ icon-128x128.png
â”‚       â”œâ”€â”€ icon-144x144.png
â”‚       â”œâ”€â”€ icon-152x152.png
â”‚       â”œâ”€â”€ icon-192x192.png
â”‚       â”œâ”€â”€ icon-384x384.png
â”‚       â””â”€â”€ icon-512x512.png
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ layout.tsx                # UPDATE: Add PWA meta tags
â”‚   â”‚   â”œâ”€â”€ page.tsx                  # UPDATE: Landing page (3 buttons)
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ route.ts          # â† NEW: Feature toggle API
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”œâ”€â”€ rooms/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ create/
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ route.ts      # UPDATE: Add approval_mode
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ join/
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ route.ts      # UPDATE: Approval logic
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ [roomId]/
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ pending-users/
â”‚   â”‚   â”‚   â”‚       â”‚   â””â”€â”€ route.ts  # â† NEW: List pending users
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ approve-user/
â”‚   â”‚   â”‚   â”‚       â”‚   â””â”€â”€ route.ts  # â† NEW: Approve/deny user
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ user-status/
â”‚   â”‚   â”‚   â”‚           â””â”€â”€ route.ts  # â† NEW: Check user status
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â””â”€â”€ queue/
â”‚   â”‚   â”‚       â”œâ”€â”€ add/
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ route.ts      # UPDATE: Check approval
â”‚   â”‚   â”‚       â””â”€â”€ add-youtube/
â”‚   â”‚   â”‚           â””â”€â”€ route.ts      # â† NEW: Add YouTube URL
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ create/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx              # â† NEW: Create room page
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ join/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx              # â† NEW: Join room page
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ tv-setup/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx              # â† NEW: TV code entry page
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ tv/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx              # UPDATE: YouTube player
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ host/
â”‚   â”‚   â”‚   â””â”€â”€ [code]/
â”‚   â”‚   â”‚       â”œâ”€â”€ page.tsx          # â† NEW: Host dashboard
â”‚   â”‚   â”‚       â””â”€â”€ approval/
â”‚   â”‚   â”‚           â””â”€â”€ page.tsx      # â† NEW: Approval queue
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ room/
â”‚   â”‚   â”‚   â””â”€â”€ [code]/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx          # UPDATE: Check approval status
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ share-target/
â”‚   â”‚       â””â”€â”€ page.tsx              # â† NEW: PWA share handler
â”‚   â”‚
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ YouTubePlayer.tsx         # â† NEW: YT iframe wrapper
â”‚   â”‚   â”œâ”€â”€ SearchRedirect.tsx        # â† NEW: YT search redirect
â”‚   â”‚   â”œâ”€â”€ ApprovalQueue.tsx         # â† NEW: Host approval list
â”‚   â”‚   â”œâ”€â”€ UserStatusBadge.tsx       # â† NEW: Approval status
â”‚   â”‚   â”œâ”€â”€ FeatureToggle.tsx         # â† NEW: Conditional rendering
â”‚   â”‚   â””â”€â”€ QRCode.tsx                # EXISTS (no changes)
â”‚   â”‚
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ config.ts                 # â† NEW: Feature toggle config
â”‚   â”‚   â”œâ”€â”€ youtube.ts                # â† NEW: YT URL utilities
â”‚   â”‚   â”œâ”€â”€ api.ts                    # UPDATE: Add approval methods
â”‚   â”‚   â”œâ”€â”€ supabase.ts               # EXISTS (no changes)
â”‚   â”‚   â””â”€â”€ utils.ts                  # EXISTS (no changes)
â”‚   â”‚
â”‚   â””â”€â”€ shared/
â”‚       â””â”€â”€ types.ts                  # UPDATE: Add approval types
â”‚
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ COMPLETE_SCHEMA_V3.1.sql      # Reference (no changes)
â”‚   â””â”€â”€ migrations/
â”‚       â””â”€â”€ v4.0_youtube_approval.sql # â† NEW: Migration script
â”‚
â””â”€â”€ Documentation/
    â”œâ”€â”€ V4.0_PLAN.md                  # â† NEW: This document
    â”œâ”€â”€ PWA_SETUP.md                  # â† NEW: PWA implementation guide
    â”œâ”€â”€ APPROVAL_WORKFLOW.md          # â† NEW: Approval system guide
    â””â”€â”€ YOUTUBE_INTEGRATION.md        # â† NEW: YouTube integration guide
```

---

## âš™ï¸ Feature Toggle Strategy

### Environment Variables

```bash
# .env (Development/Testing - Database mode)
NEXT_PUBLIC_COMMERCIAL_MODE=false

# .env-production (Production - YouTube only)
NEXT_PUBLIC_COMMERCIAL_MODE=true
```

**Deployment Strategy (Copyright Protection):**

```
Two Separate Deployments:

1. Private Deployment (kara-private.vercel.app)
   â€¢ COMMERCIAL_MODE=false
   â€¢ Database search enabled
   â€¢ Local video files
   â€¢ Private use only
   â€¢ NOT public-facing

2. Public/Commercial Deployment (kara.vercel.app)
   â€¢ COMMERCIAL_MODE=true
   â€¢ YouTube only
   â€¢ No database search
   â€¢ Commercial safe
   â€¢ Public-facing
```

**Why Two Deployments:**
- âš–ï¸ **Copyright Protection**: Cannot expose database version to public
- âœ… **Legal Compliance**: YouTube mode is safe for commercial use
- ğŸ”’ **Risk Management**: Private deployment never goes public
- ğŸ¯ **Clear Separation**: No risk of accidentally enabling DB mode publicly

### Config File

```typescript
// src/lib/config.ts
export const appConfig = {
  // Global mode toggle
  commercialMode: process.env.NEXT_PUBLIC_COMMERCIAL_MODE === 'true',
  
  // Feature flags
  features: {
    databaseSearch: process.env.NEXT_PUBLIC_COMMERCIAL_MODE !== 'true',
    youtubeSearch: process.env.NEXT_PUBLIC_COMMERCIAL_MODE === 'true',
    hostApproval: process.env.NEXT_PUBLIC_COMMERCIAL_MODE === 'true',
    pwaShare: process.env.NEXT_PUBLIC_COMMERCIAL_MODE === 'true',
  },
  
  // Player type
  player: {
    type: process.env.NEXT_PUBLIC_COMMERCIAL_MODE === 'true' 
      ? 'youtube' 
      : 'video',
  },
  
  // Polling interval (same as v3.5)
  polling: {
    intervalMs: 2500, // 2.5 seconds
  },
  
  // Room settings
  room: {
    expiryHours: 24,
    maxUsers: 50,
    maxQueueSize: 100,
  },
  
  // Approval settings
  approval: {
    expiryMinutes: 15,
  },
};
```

### Feature Toggle Component

```typescript
// src/components/FeatureToggle.tsx
'use client';

import { appConfig } from '@/lib/config';
import { ReactNode } from 'react';

interface FeatureToggleProps {
  feature: keyof typeof appConfig.features;
  children: ReactNode;
  fallback?: ReactNode;
}

export function FeatureToggle({ 
  feature, 
  children, 
  fallback = null 
}: FeatureToggleProps) {
  const isEnabled = appConfig.features[feature];
  return <>{isEnabled ? children : fallback}</>;
}

// Usage:
// <FeatureToggle feature="databaseSearch">
//   <DatabaseSearchUI />
// </FeatureToggle>
//
// <FeatureToggle feature="youtubeSearch">
//   <SearchRedirect />
// </FeatureToggle>
```

---

## ğŸ“± PWA Implementation

### 1. Manifest File

```json
// public/manifest.json
{
  "name": "Kara - Karaoke Queue Manager",
  "short_name": "Kara",
  "description": "Social karaoke queue with YouTube integration",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#000000",
  "theme_color": "#0070f3",
  "orientation": "portrait",
  "icons": [
    {
      "src": "/icons/icon-72x72.png",
      "sizes": "72x72",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-96x96.png",
      "sizes": "96x96",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-128x128.png",
      "sizes": "128x128",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-144x144.png",
      "sizes": "144x144",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-152x152.png",
      "sizes": "152x152",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-384x384.png",
      "sizes": "384x384",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ],
  "share_target": {
    "action": "/share-target",
    "method": "GET",
    "params": {
      "title": "title",
      "text": "text",
      "url": "url"
    }
  }
}
```

### 2. Service Worker (Zero Caching - Auto-Update Only)

```javascript
// public/sw.js
// IMPORTANT: NO CACHING due to Vercel limitations and real-time data requirements
// Service worker only exists for:
// 1. PWA installation
// 2. Share target functionality
// 3. Auto-update mechanism

const VERSION = 'v4-0-1';

// Install: Activate immediately, NO caching
self.addEventListener('install', (event) => {
  console.log('[SW] Installing version:', VERSION);
  self.skipWaiting(); // Auto-activate new version immediately
});

// Activate: Take control immediately, NO cache cleanup needed
self.addEventListener('activate', (event) => {
  console.log('[SW] Activating version:', VERSION);
  event.waitUntil(self.clients.claim()); // Take control of all clients immediately
});

// Fetch: ALWAYS fetch from network, NO caching, NO fallback
self.addEventListener('fetch', (event) => {
  // Always fetch fresh data from network
  event.respondWith(fetch(event.request));
});

// Message: Handle update notifications
self.addEventListener('message', (event) => {
  if (event.data && event.data.type === 'SKIP_WAITING') {
    self.skipWaiting();
  }
});
```

**Why No Caching:**
- âœ… Vercel has caching limitations
- âœ… Real-time data (queue updates every 2.5s)
- âœ… Prevents stale data issues
- âœ… Always fresh content from server
- âœ… Service worker only for PWA + share target

### 3. Layout Updates

```typescript
// src/app/layout.tsx (UPDATE)
import type { Metadata } from 'next';

export const metadata: Metadata = {
  title: 'Kara - Karaoke Queue Manager',
  description: 'Social karaoke queue with YouTube integration',
  manifest: '/manifest.json',
  themeColor: '#0070f3',
  appleWebApp: {
    capable: true,
    statusBarStyle: 'default',
    title: 'Kara',
  },
  viewport: {
    width: 'device-width',
    initialScale: 1,
    maximumScale: 1,
  },
};

export default function RootLayout({ 
  children 
}: { 
  children: React.ReactNode 
}) {
  return (
    <html lang="en">
      <head>
        {/* PWA manifest */}
        <link rel="manifest" href="/manifest.json" />
        
        {/* Apple PWA */}
        <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="default" />
        <meta name="apple-mobile-web-app-title" content="Kara" />
        
        {/* Theme color */}
        <meta name="theme-color" content="#0070f3" />
        
        {/* Register service worker */}
        <script dangerouslySetInnerHTML={{
          __html: `
            if ('serviceWorker' in navigator) {
              window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                  .then(reg => {
                    // Auto-update: check for updates every 60 seconds
                    setInterval(() => reg.update(), 60000);
                  });
              });
            }
          `
        }} />
      </head>
      <body>{children}</body>
    </html>
  );
}
```

---

## ğŸ¨ Key Pages & Components

### Landing Page

```typescript
// src/app/page.tsx (UPDATE)
'use client';

import Link from 'next/link';
import { appConfig } from '@/lib/config';

export default function HomePage() {
  return (
    <div style={{
      display: 'flex',
      flexDirection: 'column',
      alignItems: 'center',
      justifyContent: 'center',
      minHeight: '100vh',
      padding: '2rem',
      background: '#000',
      color: '#fff',
    }}>
      <h1 style={{ fontSize: '3rem', marginBottom: '1rem' }}>ğŸ¤ Kara</h1>
      <p style={{ fontSize: '1.25rem', marginBottom: '3rem', opacity: 0.8 }}>
        {appConfig.commercialMode 
          ? 'Social Karaoke Queue for YouTube' 
          : 'Karaoke Queue Manager'}
      </p>

      <div style={{ 
        display: 'flex', 
        flexDirection: 'column', 
        gap: '1rem', 
        width: '100%', 
        maxWidth: '400px' 
      }}>
        <Link href="/create" className="btn btn-primary" style={{
          padding: '1.5rem',
          fontSize: '1.25rem',
          textAlign: 'center',
          borderRadius: '12px',
          background: '#0070f3',
          color: 'white',
          textDecoration: 'none',
        }}>
          ğŸ¤ Create Room (Host)
        </Link>

        <Link href="/tv-setup" className="btn btn-secondary" style={{
          padding: '1.5rem',
          fontSize: '1.25rem',
          textAlign: 'center',
          borderRadius: '12px',
          background: '#666',
          color: 'white',
          textDecoration: 'none',
        }}>
          ğŸ“º I'm a TV/Media Player
        </Link>

        <Link href="/join" className="btn btn-secondary" style={{
          padding: '1.5rem',
          fontSize: '1.25rem',
          textAlign: 'center',
          borderRadius: '12px',
          background: '#666',
          color: 'white',
          textDecoration: 'none',
        }}>
          ğŸ‘¥ Join Room (User)
        </Link>
      </div>
    </div>
  );
}
```

### YouTube Player Component

```typescript
// src/components/YouTubePlayer.tsx (NEW)
'use client';

import { useEffect, useRef } from 'react';

interface YouTubePlayerProps {
  videoId: string;
  onEnded: () => void;
  onError: (error: number) => void;
}

export function YouTubePlayer({ 
  videoId, 
  onEnded, 
  onError 
}: YouTubePlayerProps) {
  const playerRef = useRef<any>(null);
  const containerRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    // Load YouTube IFrame API
    if (!(window as any).YT) {
      const tag = document.createElement('script');
      tag.src = 'https://www.youtube.com/iframe_api';
      const firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode?.insertBefore(tag, firstScriptTag);
    }

    // Create player when API is ready
    const initPlayer = () => {
      if (playerRef.current) {
        playerRef.current.destroy();
      }

      playerRef.current = new (window as any).YT.Player(containerRef.current, {
        videoId,
        width: '100%',
        height: '100%',
        playerVars: {
          autoplay: 1,          // Auto-play
          controls: 1,          // Show controls
          rel: 0,               // No related videos
          modestbranding: 1,    // Minimal YouTube branding
          fs: 1,                // Allow fullscreen
          playsinline: 1,       // Play inline on iOS
        },
        events: {
          onStateChange: (event: any) => {
            if (event.data === (window as any).YT.PlayerState.ENDED) {
              console.log('[YouTube] Video ended');
              onEnded();
            }
          },
          onError: (event: any) => {
            console.error('[YouTube] Player error:', event.data);
            onError(event.data);
          },
        },
      });
    };

    if ((window as any).YT && (window as any).YT.Player) {
      initPlayer();
    } else {
      (window as any).onYouTubeIframeAPIReady = initPlayer;
    }

    return () => {
      if (playerRef.current) {
        playerRef.current.destroy();
      }
    };
  }, [videoId, onEnded, onError]);

  return (
    <div 
      ref={containerRef} 
      style={{ 
        width: '100%', 
        height: '100%',
        position: 'absolute',
        top: 0,
        left: 0,
      }} 
    />
  );
}
```

### Search Redirect Component

```typescript
// src/components/SearchRedirect.tsx (NEW)
'use client';

import { useState } from 'react';

export function SearchRedirect() {
  const [query, setQuery] = useState('');

  const handleSearch = () => {
    if (!query.trim()) return;
    
    const searchUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`;
    window.open(searchUrl, '_blank');
  };

  return (
    <div style={{ padding: '1rem' }}>
      <h2>Search Songs on YouTube</h2>
      <p style={{ opacity: 0.7, margin: '0.5rem 0 1rem' }}>
        Search, then share the video with "kara" to add it to the queue
      </p>
      
      <div style={{ display: 'flex', gap: '0.5rem' }}>
        <input
          type="text"
          className="input"
          placeholder="Enter song title..."
          value={query}
          onChange={(e) => setQuery(e.target.value)}
          onKeyDown={(e) => e.key === 'Enter' && handleSearch()}
          style={{
            flex: 1,
            padding: '0.75rem',
            fontSize: '1rem',
            borderRadius: '8px',
            border: '2px solid #ddd',
          }}
        />
        <button 
          onClick={handleSearch} 
          className="btn btn-primary"
          style={{
            padding: '0.75rem 1.5rem',
            background: '#0070f3',
            color: 'white',
            borderRadius: '8px',
            fontSize: '1rem',
          }}
        >
          ğŸ” Search
        </button>
      </div>

      <div style={{ 
        marginTop: '1.5rem', 
        padding: '1rem', 
        background: 'rgba(0, 112, 243, 0.1)', 
        borderRadius: '8px' 
      }}>
        <p style={{ fontWeight: 'bold', marginBottom: '0.5rem' }}>
          How to add songs:
        </p>
        <ol style={{ paddingLeft: '1.5rem', lineHeight: 1.6 }}>
          <li>Click "Search" to open YouTube</li>
          <li>Find your song</li>
          <li>Tap the share button (â‹®)</li>
          <li>Select "kara" from the share menu</li>
          <li>Song will be added automatically!</li>
        </ol>
      </div>
    </div>
  );
}
```

### Share Target Handler

```typescript
// src/app/share-target/page.tsx (NEW)
'use client';

import { useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { api } from '@/lib/api';
import { extractYouTubeId } from '@/lib/youtube';

export default function ShareTargetPage() {
  const router = useRouter();
  const searchParams = useSearchParams();

  useEffect(() => {
    const handleShare = async () => {
      const url = searchParams.get('url');
      const title = searchParams.get('title') || 'Song';
      
      if (!url) {
        alert('No URL shared');
        router.push('/');
        return;
      }

      // Extract YouTube ID
      const youtubeId = extractYouTubeId(url);
      if (!youtubeId) {
        alert('Invalid YouTube URL');
        router.push('/');
        return;
      }

      // Get current room from localStorage
      const roomId = localStorage.getItem('current_room_id');
      const userId = localStorage.getItem('user_id');

      if (!roomId || !userId) {
        alert('Please join a room first');
        router.push('/');
        return;
      }

      try {
        // Add to queue
        await api.addYouTubeToQueue(roomId, userId, url);
        
        // Success toast (same as v3.5)
        alert(`âœ… Added "${title}" to queue!`);
        
        // Redirect to room
        const roomCode = localStorage.getItem('room_code');
        router.push(`/room/${roomCode}`);
      } catch (error: any) {
        if (error.message.includes('not approved')) {
          alert('â³ Waiting for host approval...');
        } else {
          alert('âŒ Failed to add song: ' + error.message);
        }
        router.push('/');
      }
    };

    handleShare();
  }, [searchParams, router]);

  return (
    <div style={{ 
      display: 'flex', 
      alignItems: 'center', 
      justifyContent: 'center', 
      height: '100vh',
      flexDirection: 'column',
      gap: '1rem',
    }}>
      <p style={{ fontSize: '1.25rem' }}>Adding song to queue...</p>
      <div className="spinner" />
    </div>
  );
}
```

---

## ğŸ”§ YouTube Utilities

```typescript
// src/lib/youtube.ts (NEW)

/**
 * Extract YouTube video ID from various URL formats
 */
export function extractYouTubeId(url: string): string | null {
  const patterns = [
    /(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/,
    /youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/,
    /youtube\.com\/v\/([a-zA-Z0-9_-]{11})/,
    /youtube\.com\/shorts\/([a-zA-Z0-9_-]{11})/,
  ];

  for (const pattern of patterns) {
    const match = url.match(pattern);
    if (match && match[1]) {
      return match[1];
    }
  }

  return null;
}

/**
 * Validate YouTube URL
 */
export function isValidYouTubeUrl(url: string): boolean {
  return extractYouTubeId(url) !== null;
}

/**
 * Get YouTube thumbnail URL
 */
export function getYouTubeThumbnail(
  videoId: string, 
  quality: 'default' | 'hq' | 'maxres' = 'hq'
): string {
  return `https://img.youtube.com/vi/${videoId}/${quality}default.jpg`;
}

/**
 * Build YouTube embed URL
 */
export function getYouTubeEmbedUrl(videoId: string): string {
  return `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
}
```

---

## ğŸ“¡ API Updates

### Config Endpoint

```typescript
// src/app/api/config/route.ts (NEW)
import { NextResponse } from 'next/server';
import { appConfig } from '@/lib/config';

export async function GET() {
  return NextResponse.json({
    commercialMode: appConfig.commercialMode,
    features: appConfig.features,
    polling: appConfig.polling,
  });
}
```

### Add YouTube to Queue

```typescript
// src/app/api/queue/add-youtube/route.ts (NEW)
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';
import { extractYouTubeId } from '@/lib/youtube';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

export async function POST(request: NextRequest) {
  const { roomId, userId, youtubeUrl } = await request.json();

  // Validate YouTube URL
  const videoId = extractYouTubeId(youtubeUrl);
  if (!videoId) {
    return NextResponse.json(
      { error: 'Invalid YouTube URL' }, 
      { status: 400 }
    );
  }

  // Check user approval status
  const { data: participant } = await supabase
    .from('kara_room_participants')
    .select('status')
    .eq('room_id', roomId)
    .eq('user_id', userId)
    .single();

  if (!participant || participant.status !== 'approved') {
    return NextResponse.json({ 
      error: 'User not approved',
      status: participant?.status || 'not_found',
    }, { status: 403 });
  }

  // Get current queue for position calculation
  const { data: queue } = await supabase
    .from('kara_queue')
    .select('position, user_id')
    .eq('room_id', roomId)
    .order('position', { ascending: false });

  // Calculate next position (round-robin logic - same as v3.5)
  let nextPosition = 1;
  if (queue && queue.length > 0) {
    const userPositions = queue
      .filter(q => q.user_id === userId)
      .map(q => q.position);
    const lastUserPosition = userPositions.length > 0 
      ? Math.max(...userPositions) 
      : 0;
    nextPosition = Math.max(queue[0].position + 1, lastUserPosition + 1);
  }

  // Add to queue
  const { data, error } = await supabase
    .from('kara_queue')
    .insert({
      id: crypto.randomUUID(),
      room_id: roomId,
      user_id: userId,
      youtube_url: youtubeUrl,
      source_type: 'youtube',
      status: 'pending',
      position: nextPosition,
      added_at: new Date().toISOString(),
    })
    .select()
    .single();

  if (error) {
    return NextResponse.json(
      { error: error.message }, 
      { status: 500 }
    );
  }

  return NextResponse.json(data);
}
```

### Pending Users Endpoint

```typescript
// src/app/api/rooms/[roomId]/pending-users/route.ts (NEW)
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

export async function GET(
  request: NextRequest,
  { params }: { params: { roomId: string } }
) {
  // Expire old pending users
  await supabase.rpc('expire_pending_approvals');

  // Get current pending users
  const { data, error } = await supabase
    .from('kara_room_participants')
    .select('*, kara_users(*)')
    .eq('room_id', params.roomId)
    .eq('status', 'pending')
    .order('joined_at', { ascending: true });

  if (error) {
    return NextResponse.json(
      { error: error.message }, 
      { status: 500 }
    );
  }

  return NextResponse.json(data);
}
```

### Approve User Endpoint

```typescript
// src/app/api/rooms/[roomId]/approve-user/route.ts (NEW)
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

export async function POST(
  request: NextRequest,
  { params }: { params: { roomId: string } }
) {
  const { userId, approved } = await request.json();

  const { error } = await supabase
    .from('kara_room_participants')
    .update({
      status: approved ? 'approved' : 'denied',
      approved_at: new Date().toISOString(),
    })
    .eq('room_id', params.roomId)
    .eq('user_id', userId);

  if (error) {
    return NextResponse.json(
      { error: error.message }, 
      { status: 500 }
    );
  }

  return NextResponse.json({ success: true });
}
```

---

## ğŸ“Š Implementation Phases

### **Phase 0: Planning & Design** âœ… (Complete)
- [x] Map complete user flows
- [x] Define device roles
- [x] Document edge cases
- [x] Review existing schema
- [x] Minimize schema changes

---

### **Phase 1: Foundation** (Week 1)
**Goal**: Core infrastructure and database migration

**Tasks**:
- [ ] Create database migration script
- [ ] Run migration on dev database
- [ ] Test rollback safety
- [ ] Create feature toggle config
- [ ] Create `FeatureToggle` component
- [ ] Update landing page (3 buttons)
- [ ] Create basic routing structure
- [ ] Test with `COMMERCIAL_MODE=false` (v3.5 behavior)
- [ ] Test with `COMMERCIAL_MODE=true` (v4.0 behavior)

**Deliverable**: Database ready, toggle working

---

### **Phase 2: PWA Setup** (Week 1-2)
**Goal**: App installable as PWA with share target

**Tasks**:
- [ ] Create PWA manifest
- [ ] Generate app icons (8 sizes)
- [ ] Create service worker (auto-update)
- [ ] Update layout with PWA meta tags
- [ ] Create `/share-target` page
- [ ] Test installation on iOS
- [ ] Test installation on Android
- [ ] Test share from YouTube â†’ Kara
- [ ] Verify auto-update works

**Deliverable**: Installable PWA with share target

---

### **Phase 3: YouTube Integration** (Week 2)
**Goal**: YouTube playback on TV

**Tasks**:
- [ ] Create `YouTubePlayer` component
- [ ] Create `youtube.ts` utilities
- [ ] Update TV page to use YouTube iframe
- [ ] Add YouTube error handling (deleted/private videos)
- [ ] Test video playback
- [ ] Test auto-advance
- [ ] Test on FireTV browser
- [ ] Test on Smart TV browser

**Deliverable**: TV can play YouTube videos

---

### **Phase 4: Search & Share Flow** (Week 2-3)
**Goal**: Users can search YouTube and share

**Tasks**:
- [ ] Create `SearchRedirect` component
- [ ] Add search to room page (with feature toggle)
- [ ] Test redirect to YouTube
- [ ] Test share flow on iOS
- [ ] Test share flow on Android
- [ ] Add YouTube to queue API endpoint
- [ ] Test queue with YouTube URLs
- [ ] Test round-robin with YouTube

**Deliverable**: Search & share working

---

### **Phase 5: Room Creation & Join** (Week 3)
**Goal**: Host creates room, users join

**Tasks**:
- [ ] Create `/create` page (host)
- [ ] Create `/join` page (user)
- [ ] Create `/tv-setup` page (TV)
- [ ] Update room creation API (add approval_mode)
- [ ] Update room join API (approval logic)
- [ ] Test Auto Join mode
- [ ] Test Host Approval mode
- [ ] Test TV join flow
- [ ] Test room expiry (24 hours)

**Deliverable**: Room creation & join flows working

---

### **Phase 6: Approval System** (Week 3-4)
**Goal**: Host approval workflow

**Tasks**:
- [ ] Create host dashboard page
- [ ] Create approval queue page
- [ ] Create `ApprovalQueue` component
- [ ] Create `UserStatusBadge` component
- [ ] Implement pending users API
- [ ] Implement approve/deny API
- [ ] Add approval check to queue endpoints
- [ ] Test auto-expiry (15 min)
- [ ] Test approval/denial flow
- [ ] Test pending user experience

**Deliverable**: Approval system working

---

### **Phase 7: Queue Management** (Week 4)
**Goal**: YouTube videos in queue

**Tasks**:
- [ ] Update queue display for YouTube
- [ ] Add YouTube thumbnail support
- [ ] Test queue with YouTube only
- [ ] Test mixed queue (DB + YouTube) if toggle off
- [ ] Test skip with YouTube
- [ ] Test reorder with YouTube
- [ ] Test host override with YouTube
- [ ] Test queue polling (2.5s interval)

**Deliverable**: Queue fully supports YouTube

---

### **Phase 8: Testing & Polish** (Week 4-5)
**Goal**: End-to-end testing

**Cross-Device Testing**:
- [ ] iPhone (iOS 15+)
- [ ] Android phone (10+)
- [ ] iPad
- [ ] Android tablet
- [ ] FireTV browser
- [ ] Smart TV browser
- [ ] Desktop Chrome
- [ ] Desktop Safari

**Feature Testing**:
- [ ] PWA installation
- [ ] Share target
- [ ] YouTube playback
- [ ] Approval workflow
- [ ] Room expiry
- [ ] Queue management
- [ ] Round-robin logic
- [ ] Auto-update

**Edge Cases**:
- [ ] Network interruption
- [ ] Host leaves (room ends)
- [ ] TV disconnects (auto-reconnect)
- [ ] YouTube video deleted
- [ ] Approval expired
- [ ] Multiple TVs in room
- [ ] Room at capacity (50 users)
- [ ] Queue at capacity (100 songs)

**Deliverable**: Stable, tested v4.0

---

### **Phase 9: Documentation** (Week 5)
**Goal**: Complete documentation

**Tasks**:
- [ ] Write `PWA_SETUP.md`
- [ ] Write `APPROVAL_WORKFLOW.md`
- [ ] Write `YOUTUBE_INTEGRATION.md`
- [ ] Update `README.md`
- [ ] Create user guide
- [ ] Create host guide
- [ ] Record demo video
- [ ] Document troubleshooting

**Deliverable**: Comprehensive docs

---

### **Phase 10: Deployment** (Week 5-6)
**Goal**: Deploy to production (two separate deployments)

**Deployment 1: Private/Testing (Optional)**:
- [ ] Create separate Vercel project: `kara-private`
- [ ] Set `NEXT_PUBLIC_COMMERCIAL_MODE=false`
- [ ] Deploy (for private use with local videos)
- [ ] Restrict access (password/IP whitelist)
- [ ] Test database mode

**Deployment 2: Public/Commercial (Primary)**:
- [ ] Use main Vercel project: `kara`
- [ ] Set `NEXT_PUBLIC_COMMERCIAL_MODE=true` in production
- [ ] Deploy to Vercel
- [ ] Test PWA on production
- [ ] Test share target on production
- [ ] Monitor errors (Vercel logs)
- [ ] Monitor performance
- [ ] Create v4.0 git tag
- [ ] Announce launch

**Important**: 
- âš ï¸ **Never set `COMMERCIAL_MODE=false` on public domain**
- âš ï¸ **Database mode is for private use only** (copyright protection)
- âœ… **Public deployment must always be YouTube-only**

**Deliverable**: v4.0 live in production (commercial-safe)

---

## âœ… Testing Checklist

### PWA
- [ ] App installs on iOS Safari
- [ ] App installs on Android Chrome
- [ ] Share target appears in share menu
- [ ] Share target receives YouTube URLs
- [ ] Service worker registers properly (NO caching)
- [ ] Auto-update works (no prompts)
- [ ] App icons display correctly
- [ ] Splash screen works
- [ ] All data is always fresh (never stale)

### Approval System
- [ ] Host creates Auto Join room
- [ ] Host creates Host Approval room
- [ ] Users auto-approved in Auto Join
- [ ] Users pending in Host Approval
- [ ] Host sees pending list
- [ ] Host can approve
- [ ] Host can deny
- [ ] Approvals expire after 15 min
- [ ] Expired users auto-denied

### YouTube Integration
- [ ] YouTube videos play on TV
- [ ] YouTube ads play (important!)
- [ ] Video auto-advances
- [ ] Deleted video error handling
- [ ] Private video error handling
- [ ] Search redirect works
- [ ] Share from YouTube works
- [ ] URL validation works

### Queue
- [ ] YouTube videos added
- [ ] Round-robin works
- [ ] Position calculation correct
- [ ] Skip works
- [ ] Reorder works
- [ ] Queue displays YouTube info
- [ ] Polling every 2.5s

### Feature Toggle
- [ ] `COMMERCIAL_MODE=false` â†’ v3.5
- [ ] `COMMERCIAL_MODE=true` â†’ v4.0
- [ ] DB search hidden in commercial
- [ ] YouTube shown in commercial
- [ ] No errors switching modes

### Room Management
- [ ] Rooms expire after 24 hours
- [ ] Host can end room
- [ ] Host leaves â†’ room ends
- [ ] Multiple TVs work (mirror)
- [ ] Max 50 users enforced
- [ ] Max 100 songs enforced

---

## ğŸ¯ Success Criteria

**v4.0 is ready for production when**:

1. âœ… All PWA features work on iOS and Android
2. âœ… YouTube share target adds songs to queue
3. âœ… Host approval system works with 15-min expiry
4. âœ… YouTube videos play on TV with ads
5. âœ… Rooms expire after 24 hours
6. âœ… No copyright issues (YouTube hosts everything)
7. âœ… Feature toggle works (v3.5 â†” v4.0)
8. âœ… All tests pass
9. âœ… Documentation complete
10. âœ… Zero breaking changes to v3.5

---

## ğŸ“ˆ Benefits Over Current Setup

| Feature | v3.5 (DB Mode) | v4.0 (YouTube Mode) |
|---------|----------------|---------------------|
| **Copyright** | âŒ Risky | âœ… Safe |
| **Commercial** | âŒ No | âœ… Yes |
| **Maintenance** | âŒ High (video hosting) | âœ… Low (YouTube hosts) |
| **Song Library** | âš ï¸ Limited (14K songs) | âœ… Unlimited (YouTube) |
| **Multi-user** | âœ… Yes | âœ… Yes |
| **Approval** | âŒ No | âœ… Yes (spam control) |
| **Cost** | âš ï¸ Storage + bandwidth | âœ… Free (YouTube) |
| **Legal** | âŒ Infringement risk | âœ… Compliant |

---

## ğŸš¨ Important Notes

### âš–ï¸ Legal Compliance & Copyright Protection

**YouTube Mode (Commercial/Public):**
- âœ… YouTube hosts all videos
- âœ… YouTube serves all ads
- âœ… We don't download or store videos
- âœ… We're just a queue manager
- âœ… Same as creating a YouTube playlist
- âœ… **Legally safe for commercial use**

**Database Mode (Private Only):**
- âš ï¸ **NEVER expose to public** (copyright infringement)
- âš ï¸ **Private deployment only** (password-protected)
- âš ï¸ **For personal/private use only**
- âš ï¸ **High legal risk if public**

**Deployment Rules:**
```
âœ… DO: Public domain â†’ COMMERCIAL_MODE=true (YouTube only)
âŒ DON'T: Public domain â†’ COMMERCIAL_MODE=false (legal risk!)
âœ… DO: Private domain â†’ COMMERCIAL_MODE=false (for testing)
âŒ DON'T: Accidentally expose database mode publicly
```

### ğŸ”’ Zero Caching Policy

**Why No Caching:**
- âœ… Vercel has caching limitations
- âœ… Real-time queue updates (2.5s polling)
- âœ… Prevents stale data
- âœ… Approval status must be fresh
- âœ… Room state must be current

**Service Worker Role:**
- âœ… PWA installation only
- âœ… Share target functionality
- âœ… Auto-update mechanism
- âŒ NO data caching
- âŒ NO offline mode
- âŒ NO fallback content

### No Backward Compatibility Issues
- âœ… Feature toggle preserves v3.5 behavior
- âœ… Database schema is backward compatible
- âœ… No data migration needed
- âœ… Can switch modes anytime via `.env` (per deployment)

### Performance
- âœ… Same polling strategy (2.5s)
- âœ… **ZERO caching anywhere** (service worker, API, browser)
- âœ… No real-time subscriptions (WebSockets)
- âœ… Same as v3.5 architecture
- âœ… Always fetch fresh data from network
- âœ… Service worker only for PWA registration

### User Experience
- âœ… Simpler search (YouTube UI)
- âœ… Better song discovery (YouTube recommendations)
- âœ… Spam control (host approval)
- âœ… Fair rotation (round-robin)
- âœ… Auto-update PWA (no prompts)
- âœ… Always fresh data (never stale)

---

## ğŸ“ Next Steps

1. **Review this plan** - Confirm all requirements are captured
2. **Start Phase 1** - Database migration
3. **Iterate rapidly** - Test each phase before moving on
4. **Deploy to production** - Set `COMMERCIAL_MODE=true`

---

**Ready to start Phase 1?** ğŸš€
