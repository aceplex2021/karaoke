# COMPLETE SYSTEM ARCHITECTURE

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER DOWNLOADS                          â”‚
â”‚                    (via MeTube web interface)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    /Videos/Incoming/*.mp4                       â”‚
â”‚                    (Raw, messy filenames)                       â”‚
â”‚   "ï½œ Khi Nao Chau Duong ï½œ Chuan [Nam - Trong Hieu].mp4"      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     NODE CONTROLLER (Docker)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  parseFilename() - NOW WITH CLEANUP LOGIC:                â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  1. cleanTitle()                                          â”‚ â”‚
â”‚  â”‚     Remove: pipes, paths, "karaoke", "nhac song", etc.   â”‚ â”‚
â”‚  â”‚     "ï½œ Khi Nao ï½œ Chuan" â†’ "Khi Nao Chau Duong"         â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  2. extractArtist()                                       â”‚ â”‚
â”‚  â”‚     Patterns: English, Vietnamese composer, KARAOKE fmt   â”‚ â”‚
â”‚  â”‚     "Aespa Whiplash" â†’ "Aespa"                           â”‚ â”‚
â”‚  â”‚     "Tinh Don Phuong (Trinh Cong Son)" â†’ "Trinh CS"     â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  3. detectPerformanceType()                               â”‚ â”‚
â”‚  â”‚     "song ca" â†’ "duet"                                    â”‚ â”‚
â”‚  â”‚     "lien khuc" â†’ "medley"                                â”‚ â”‚
â”‚  â”‚     "hop ca" â†’ "group"                                    â”‚ â”‚
â”‚  â”‚     default â†’ "solo"                                      â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  4. cleanTone()                                           â”‚ â”‚
â”‚  â”‚     "nam"/"male"/"boy" â†’ "Nam"                           â”‚ â”‚
â”‚  â”‚     "nu"/"female"/"girl" â†’ "Ná»¯"                          â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  5. extractChannel()                                      â”‚ â”‚
â”‚  â”‚     Detect: "Trá»ng Hiáº¿u", "Kim Quy", etc.               â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  6. extractStyle()                                        â”‚ â”‚
â”‚  â”‚     Detect: "Beat", "Bolero", "Ballad", "Remix", etc.   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Creates hardlink in /Videos (flat)                 â”‚
â”‚                    /Videos/khi_nao_chau_duong.mp4              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   SUPABASE (Clean Data Only!)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  kara_song_groups:                                        â”‚ â”‚
â”‚  â”‚    base_title_display: "Khi Nao Chau Duong"  âœ… Clean!   â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  kara_songs:                                              â”‚ â”‚
â”‚  â”‚    title: "Khi Nao Chau Duong"  âœ… Clean!               â”‚ â”‚
â”‚  â”‚    artist_name: "Äinh TÃ¹ng Huy"  âœ… Extracted!          â”‚ â”‚
â”‚  â”‚    performance_type: "solo"  âœ… Detected!               â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  kara_versions:                                           â”‚ â”‚
â”‚  â”‚    label: "nam_trong_hieu_beat"                          â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  kara_files:                                              â”‚ â”‚
â”‚  â”‚    storage_path: "/Videos/khi_nao_chau_duong.mp4"       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WEBAPP API (Read-Only)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  /api/songs/search?q=khi                                  â”‚ â”‚
â”‚  â”‚    Returns: Clean titles from kara_song_groups           â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  /api/songs/group/[groupId]/versions                     â”‚ â”‚
â”‚  â”‚    Returns: Enhanced metadata                             â”‚ â”‚
â”‚  â”‚      - tone: "Nam"  âœ…                                    â”‚ â”‚
â”‚  â”‚      - channel: "Trá»ng Hiáº¿u"  âœ…                         â”‚ â”‚
â”‚  â”‚      - style: "Beat"  âœ…                                  â”‚ â”‚
â”‚  â”‚      - artist_name: "Äinh TÃ¹ng Huy"  âœ…                 â”‚ â”‚
â”‚  â”‚      - performance_type: "solo"  âœ…                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER SEES (UI)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Search Results:                                          â”‚ â”‚
â”‚  â”‚    "Khi Nao Chau Duong" âœ… (no pipes!)                   â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  Version Display:                                         â”‚ â”‚
â”‚  â”‚    Tone: Nam - Channel: Trá»ng Hiáº¿u - Style: Beat -      â”‚ â”‚
â”‚  â”‚    Artist: Äinh TÃ¹ng Huy  âœ…                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


KEY PRINCIPLES:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… Clean at ingestion (node controller)
âŒ NOT at query time (webapp/database)

âœ… Single source of truth for cleanup logic
âŒ NOT scattered across SQL scripts

âœ… Database stores only clean data
âŒ NOT raw filenames with post-processing

âœ… Automated for new downloads
âŒ NOT manual intervention needed


OLD WAY (Manual):                  NEW WAY (Automated):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”                  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. Index raw data                  1. Parse + Clean
2. Run SQL cleanup                 2. Write clean data
3. Hard refresh browser            3. Done! âœ…
4. Repeat for new songs


RESULT:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ‰ Self-cleaning karaoke system
ğŸ‰ No manual intervention needed
ğŸ‰ Clean data automatically, always
ğŸ‰ Beautiful UI without extra work
```

---

## File Responsibilities

| Component | Responsibility | Files |
|-----------|---------------|-------|
| **Node Controller** | Parse, clean, promote, index | `scripts/index-songs.ts` |
| **Database** | Store clean data only | Supabase tables |
| **Webapp API** | Read and serve clean data | `src/app/api/songs/*` |
| **Webapp UI** | Display data beautifully | `src/app/room/[code]/page.tsx` |

---

## Data Flow Example

### Input (Raw Download):
```
/Videos/Incoming/ï½œ Khi Nao Chau Duong ï½œ Chuan [Nam - Trong Hieu - Beat].mp4
```

### Node Controller Processing:
```typescript
parseFilename() applies:
  cleanTitle()         â†’ "Khi Nao Chau Duong"
  extractArtist()      â†’ null (mixer not artist)
  detectPerformanceType() â†’ "solo"
  cleanTone()          â†’ "Nam"
  extractChannel()     â†’ "Trá»ng Hiáº¿u"
  extractStyle()       â†’ "Beat"
```

### Database Storage:
```sql
INSERT INTO kara_songs (
  title,              -- "Khi Nao Chau Duong"
  artist_name,        -- null
  performance_type    -- "solo"
);

INSERT INTO kara_versions (
  label               -- "nam_trong_hieu_beat"
);
```

### API Response:
```json
{
  "display_title": "Khi Nao Chau Duong",
  "versions": [{
    "tone": "Nam",
    "channel": "Trá»ng Hiáº¿u",
    "style": "Beat",
    "performance_type": "solo"
  }]
}
```

### UI Display:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Khi Nao Chau Duong                 â”‚
â”‚                                     â”‚
â”‚ Tone: Nam - Channel: Trá»ng Hiáº¿u -  â”‚
â”‚ Style: Beat                         â”‚
â”‚                                     â”‚
â”‚ [Add to Queue]  [See 2 versions]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Perfect! Clean data all the way through. ğŸ‰
