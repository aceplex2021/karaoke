# v4.5.2: User-Global History & Favorites

**Date:** 2026-01-22  
**Purpose:** Make song history and favorites persistent across all rooms (user-global, not room-specific)

---

## Problem Statement

**Before v4.5.2:**
- Song history was **room-specific** (tracked separately per room)
- User sings "Song A" in Room 1 → History entry in Room 1
- User sings "Song A" in Room 2 → **New separate** history entry in Room 2
- History would "reset" when joining a new room (confusing UX)

**User Feedback:**
> "We should keep songs history to user, not room specific; this way users can view history for what they sing and doesn't get reset"

---

## Solution: User-Global History

### Database Changes

#### 1. **kara_song_history Table**
```sql
-- OLD: Unique constraint included room_id
CREATE UNIQUE INDEX idx_history_room_user_version 
  ON kara_song_history(room_id, user_id, version_id);

-- NEW: Unique constraint only on user + song
CREATE UNIQUE INDEX idx_history_user_version 
  ON kara_song_history(user_id, version_id);

-- Note: room_id column kept for reference (shows where song was last sung)
```

**Key Change:** History entries are now uniquely identified by `(user_id, version_id)` only, making them **user-global**.

#### 2. **Migration Process** (`v4.5.2_user_global_history.sql`)
```sql
-- Step 1: Merge duplicate entries
-- If user sang same song in multiple rooms, consolidate into one entry
-- Keep highest times_sung + most recent sung_at

-- Step 2: Drop old constraint, create new one

-- Step 3: Update advance_playback function
-- Remove room_id from history lookup
```

---

### Code Changes

#### 1. **advance_playback Function**
```sql
-- OLD: Filtered by room_id
SELECT id INTO v_existing_history_id
FROM kara_song_history
WHERE room_id = p_room_id          -- ❌ Room-specific
  AND user_id = v_current_user_id
  AND version_id = v_current_version_id;

-- NEW: No room filter (user-global)
SELECT id INTO v_existing_history_id
FROM kara_song_history
WHERE user_id = v_current_user_id   -- ✅ User-global
  AND version_id = v_current_version_id;

-- When updating: Set room_id to current room (for reference)
UPDATE kara_song_history
SET 
  times_sung = times_sung + 1,
  sung_at = NOW(),
  room_id = p_room_id,  -- Track most recent room
  updated_at = NOW()
WHERE id = v_existing_history_id;
```

#### 2. **API Route** (`src/app/api/users/[userId]/history/route.ts`)
```typescript
// OLD: Optional room filter
async getUserHistory(userId: string, roomId?: string)

// NEW: Always user-global (no room filter)
async getUserHistory(userId: string)

// Query changes:
// - kara_song_history: No .eq('room_id', roomId)
// - kara_queue (YouTube): No .eq('room_id', roomId)
```

#### 3. **Frontend** (`src/app/room/[code]/page.tsx`)
```typescript
// OLD: Passed room.id
api.getUserHistory(user.id, room.id)

// NEW: No room parameter
api.getUserHistory(user.id)
```

---

## Benefits

### ✅ **User Experience**
- **Persistent history** across all rooms
- Users can see **all songs they've ever sung** (last 12 months)
- No confusing "reset" when joining new rooms
- Accurate `times_sung` count (tracks globally, not per-room)

### ✅ **Favorites Already User-Global**
- Favorites were already stored in `kara_user_preferences` by `user_id` only
- No changes needed for favorites (already working correctly)

---

## Migration Steps

### For Production Deployment:

1. **Run Database Migration:**
   ```sql
   -- In Supabase SQL Editor, execute:
   -- database/v4.5.2_user_global_history.sql
   ```
   
   This will:
   - Merge duplicate history entries (same user + song across rooms)
   - Update unique constraint to `(user_id, version_id)`
   - Update `advance_playback` function

2. **Deploy Code:**
   ```bash
   git add .
   git commit -m "v4.5.2: User-global history - never reset"
   git push origin main
   ```

3. **Verify:**
   - Check Supabase for constraint changes
   - Test: User sings song in Room A, then Room B
   - Confirm: Same history entry, `times_sung` incremented

---

## Technical Details

### History Data Structure (After v4.5.2)

```typescript
{
  id: UUID,
  room_id: UUID,        // Reference: where song was LAST sung
  user_id: UUID,        // ✅ Part of unique constraint
  version_id: UUID,     // ✅ Part of unique constraint
  sung_at: TIMESTAMP,   // Most recent time sung
  times_sung: INTEGER,  // Total count across ALL rooms
  created_at: TIMESTAMP,
  updated_at: TIMESTAMP
}
```

### Unique Constraint Logic

**Before:** `(room_id, user_id, version_id)`
- User "John" + Song "ABC" + Room 1 → Entry 1
- User "John" + Song "ABC" + Room 2 → Entry 2 (separate)

**After:** `(user_id, version_id)`
- User "John" + Song "ABC" → Single entry (across all rooms)
- `room_id` updated to most recent room
- `times_sung` increments globally

---

## Breaking Changes

⚠️ **None** - This is a pure enhancement:
- No API signature changes (roomId parameter simply ignored if passed)
- Frontend gracefully handles both old and new API behavior
- Existing history data preserved and consolidated

---

## Testing Checklist

- [ ] Run `v4.5.2_user_global_history.sql` in Supabase
- [ ] Deploy code to production
- [ ] User A joins Room 1, sings "Song X" → Check history shows entry
- [ ] User A joins Room 2, sings "Song X" again → Check `times_sung` = 2
- [ ] User A views history in Room 3 → Should see both songs from Rooms 1 & 2
- [ ] Favorites persist across all rooms (already working)
- [ ] YouTube history shows across all rooms

---

## Files Changed

### Database:
- `database/v4.5.2_user_global_history.sql` (NEW)

### Backend:
- `src/app/api/users/[userId]/history/route.ts`

### Frontend:
- `src/app/room/[code]/page.tsx`
- `src/lib/api.ts`

---

## Related Documentation

- See `V4.0_IMPLEMENTATION_COMPLETE.md` for overall v4.0 architecture
- See `V4.4_APPROVAL_FIXES.md` for participant management
- See `V4.4_REALTIME_SYNC.md` for Realtime subscription patterns

---

**Status:** ✅ Ready for deployment  
**Version:** 4.5.2  
**Author:** AI Assistant  
**Approved By:** User (aceon)
